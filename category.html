<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ†ç±»è¯¦æƒ… - AIå·¥å…·å¯¼èˆªç«™</title>
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/components.css">
</head>
<body>
  <header>
    <nav class="container">
      <a href="index.html" class="logo">AIå·¥å…·å¯¼èˆªç«™</a>
      <ul class="nav-links">
        <li><a href="index.html">é¦–é¡µ</a></li>
        <li><button class="btn btn-outline" id="settingsBtn">è®¾ç½®</button></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <div class="page-header">
      <h1 id="category-title">åˆ†ç±»èµ„æº</h1>
      <p id="category-description"></p>
    </div>

    <!-- èµ„æºç±»å‹ç­›é€‰ -->
    <div class="search-bar">
      <select id="typeFilter" style="padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 0.5rem;">
        <option value="">æ‰€æœ‰ç±»å‹</option>
        <option value="guide">å­¦ä¹ æŒ‡å—</option>
        <option value="blogger">æ¨èåšä¸»</option>
        <option value="case">ç²¾å½©æ¡ˆä¾‹</option>
        <option value="tool">å·¥å…·æ¨è</option>
      </select>
      <input type="text" id="searchInput" placeholder="æœç´¢èµ„æº...">
      <button class="btn btn-primary" id="searchBtn">æœç´¢</button>
    </div>

    <div id="resources-container" class="card-grid">
      <div class="loading">
        <div class="spinner"></div>
        <p>åŠ è½½ä¸­...</p>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2024 AIå·¥å…·å¯¼èˆªç«™. All rights reserved.</p>
    </div>
  </footer>

  <!-- é…ç½®é¢æ¿ Modal -->
  <div class="modal" id="configModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>APIé…ç½®</h2>
        <button class="modal-close" id="closeConfig">&times;</button>
      </div>
      <div class="modal-body">
        <form id="configForm">
          <div class="form-group">
            <label for="apiUrl">APIåœ°å€</label>
            <input type="text" id="apiUrl" placeholder="https://open.bigmodel.cn/api/paas/v4/chat/completions" required>
          </div>
          <div class="form-group">
            <label for="apiKey">APIå¯†é’¥</label>
            <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„APIå¯†é’¥" required>
          </div>
          <div class="form-group">
            <label for="modelName">æ¨¡å‹åç§°</label>
            <input type="text" id="modelName" placeholder="glm-4" value="glm-4" required>
          </div>
          <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button type="submit" class="btn btn-primary" style="flex: 1;">ä¿å­˜é…ç½®</button>
            <button type="button" class="btn btn-secondary" id="cancelConfig">å–æ¶ˆ</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- AI èŠå¤©ç•Œé¢ -->
  <div class="chat-widget" id="chatWidget" style="display: none;">
    <button class="chat-button" id="chatToggle">ğŸ’¬</button>
    <div class="chat-window" id="chatWindow">
      <div class="chat-header">
        <h3>AIåŠ©æ‰‹</h3>
        <button class="chat-close" id="chatClose">&times;</button>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜...">
        <button id="chatSend">å‘é€</button>
      </div>
    </div>
  </div>

  <script src="assets/js/supabase-config.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/config.js"></script>
  <script src="assets/js/chat.js"></script>
  <script>
    // åŠ è½½åˆ†ç±»å’Œèµ„æº
    async function loadCategoryAndResources() {
      const urlParams = new URLSearchParams(window.location.search);
      const categoryId = urlParams.get('id');
      
      const categoryTitle = document.getElementById('category-title');
      const categoryDescription = document.getElementById('category-description');
      const container = document.getElementById('resources-container');

      if (!categoryId) {
        container.innerHTML = '<div class="alert alert-error">åˆ†ç±»IDæ— æ•ˆ</div>';
        return;
      }

      try {
        // åŠ è½½åˆ†ç±»ä¿¡æ¯
        const category = await window.api.categories.getById(categoryId);
        if (categoryTitle) categoryTitle.textContent = category.name;
        if (categoryDescription) categoryDescription.textContent = category.description || '';

        // åŠ è½½èµ„æº
        await loadResources(categoryId);
      } catch (error) {
        container.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    async function loadResources(categoryId, type = '') {
      const container = document.getElementById('resources-container');
      
      try {
        const filters = {
          category_id: categoryId
        };
        if (type) filters.type = type;
        
        const resources = await window.api.resources.getAll(filters);

        if (resources.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“</div>
              <h3>æš‚æ— èµ„æº</h3>
              <p>è¯¥åˆ†ç±»ä¸‹è¿˜æ²¡æœ‰å­¦ä¹ èµ„æº</p>
            </div>
          `;
          return;
        }

        container.innerHTML = resources.map(resource => `
          <div class="card resource-card" onclick="window.location.href='resource-detail.html?id=${resource.id}'">
            ${resource.image_url ? `<img src="${resource.image_url}" alt="${resource.title}" class="resource-image" onerror="this.style.display='none'">` : ''}
            <span class="resource-type type-badge ${resource.type}">${getTypeName(resource.type)}</span>
            <h3>${resource.title}</h3>
            <p class="description">${resource.description || ''}</p>
            ${resource.tags ? `
              <div class="tags">
                ${resource.tags.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join('')}
              </div>
            ` : ''}
            <div class="footer">
              <span class="text-secondary">${resource.author || 'æœªçŸ¥ä½œè€…'}</span>
              <span class="text-secondary">ğŸ‘ ${resource.view_count || 0}</span>
            </div>
          </div>
        `).join('');
      } catch (error) {
        container.innerHTML = `<div class="alert alert-error">åŠ è½½èµ„æºå¤±è´¥: ${error.message}</div>`;
      }
    }

    function getTypeName(type) {
      const typeMap = {
        'guide': 'å­¦ä¹ æŒ‡å—',
        'blogger': 'æ¨èåšä¸»',
        'case': 'ç²¾å½©æ¡ˆä¾‹',
        'tool': 'å·¥å…·æ¨è'
      };
      return typeMap[type] || type;
    }

    // ç­›é€‰åŠŸèƒ½
    document.getElementById('typeFilter').addEventListener('change', (e) => {
      const categoryId = new URLSearchParams(window.location.search).get('id');
      loadResources(categoryId, e.target.value);
    });

    document.getElementById('searchBtn').addEventListener('click', () => {
      // æœç´¢åŠŸèƒ½å¯ä»¥åç»­å®ç°
      alert('æœç´¢åŠŸèƒ½å¼€å‘ä¸­...');
    });

    document.addEventListener('DOMContentLoaded', loadCategoryAndResources);
  </script>
</body>
</html>