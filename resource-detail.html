<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èµ„æºè¯¦æƒ… - AIå­¦ä¹ å¯¼èˆªç«™</title>
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/components.css">
</head>
<body>
  <header>
    <nav class="container">
      <a href="index.html" class="logo">AIå­¦ä¹ å¯¼èˆªç«™</a>
      <ul class="nav-links">
        <li><a href="index.html">é¦–é¡µ</a></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <div id="resource-detail-container">
      <div class="loading">
        <div class="spinner"></div>
        <p>åŠ è½½ä¸­...</p>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2024 AIå­¦ä¹ å¯¼èˆªç«™. All rights reserved.</p>
    </div>
  </footer>

  <!-- AI Chat Widget -->
  <div class="chat-widget">
    <button class="chat-button" id="chatToggle">ğŸ’¬</button>
    <div class="chat-window" id="chatWindow">
      <div class="chat-header">
        <h3>AIå­¦ä¹ åŠ©æ‰‹</h3>
        <button class="chat-close" id="chatClose">&times;</button>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜...">
        <button id="chatSend">å‘é€</button>
      </div>
    </div>
  </div>

  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/zhipu-chat.js"></script>
  <script>
    let currentResource = null;
    let isFavorited = false;

    async function loadResourceDetail() {
      const urlParams = new URLSearchParams(window.location.search);
      const resourceId = urlParams.get('id');
      const container = document.getElementById('resource-detail-container');

      if (!resourceId) {
        container.innerHTML = '<div class="alert alert-error">èµ„æºIDæ— æ•ˆ</div>';
        return;
      }

      try {
        const resource = await window.api.resources.getById(resourceId);
        currentResource = resource;

        // Check if favorited
        const user = await window.auth.checkAuth();
        if (user) {
          try {
            const favorites = await window.api.favorites.getAll();
            isFavorited = favorites.some(fav => fav.id === resource.id);
          } catch (error) {
            console.error('Failed to check favorites:', error);
          }
        }

        container.innerHTML = `
          <div class="card" style="max-width: 900px; margin: 2rem auto;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
              <span class="type-badge ${resource.type}">${window.main.getTypeName(resource.type)}</span>
              ${user ? `
                <button class="favorite-btn ${isFavorited ? 'active' : ''}" id="favoriteBtn">
                  ${isFavorited ? 'â¤ï¸' : 'ğŸ¤'}
                </button>
              ` : ''}
            </div>
            ${resource.image_url ? `<img src="${resource.image_url}" alt="${resource.title}" style="width: 100%; height: 400px; object-fit: cover; border-radius: 0.5rem; margin-bottom: 1.5rem;" onerror="this.style.display='none'">` : ''}
            <h1 style="font-size: 2rem; margin-bottom: 1rem;">${resource.title}</h1>
            <div style="color: var(--text-secondary); margin-bottom: 1.5rem;">
              <p><strong>ä½œè€…:</strong> ${resource.author || 'æœªçŸ¥'}</p>
              <p><strong>æµè§ˆ:</strong> ${resource.view_count || 0} æ¬¡</p>
            </div>
            ${resource.tags ? `
              <div class="tags" style="margin-bottom: 1.5rem;">
                ${resource.tags.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join('')}
              </div>
            ` : ''}
            <div style="margin-bottom: 1.5rem; line-height: 1.8;">
              <h2 style="margin-bottom: 0.5rem;">æè¿°</h2>
              <p style="white-space: pre-wrap;">${resource.description || 'æš‚æ— æè¿°'}</p>
            </div>
            ${resource.url ? `
              <a href="${resource.url}" target="_blank" class="btn btn-primary" style="display: inline-block;">
                è®¿é—®èµ„æº â†’
              </a>
            ` : ''}
          </div>
        `;

        // Add favorite button handler
        if (user) {
          const favoriteBtn = document.getElementById('favoriteBtn');
          favoriteBtn.addEventListener('click', toggleFavorite);
        }
      } catch (error) {
        container.innerHTML = `
          <div class="alert alert-error">
            åŠ è½½èµ„æºå¤±è´¥: ${error.message}
          </div>
        `;
      }
    }

    async function toggleFavorite() {
      const user = await window.auth.checkAuth();
      if (!user) {
        alert('è¯·å…ˆç™»å½•');
        window.location.href = 'login.html';
        return;
      }

      const favoriteBtn = document.getElementById('favoriteBtn');
      favoriteBtn.disabled = true;

      try {
        if (isFavorited) {
          await window.api.favorites.remove(currentResource.id);
          isFavorited = false;
          favoriteBtn.textContent = 'ğŸ¤';
          favoriteBtn.classList.remove('active');
        } else {
          await window.api.favorites.add(currentResource.id);
          isFavorited = true;
          favoriteBtn.textContent = 'â¤ï¸';
          favoriteBtn.classList.add('active');
        }
      } catch (error) {
        alert('æ“ä½œå¤±è´¥: ' + error.message);
      } finally {
        favoriteBtn.disabled = false;
      }
    }

    document.addEventListener('DOMContentLoaded', loadResourceDetail);
  </script>
  <script src="assets/js/main.js"></script>
</body>
</html>
